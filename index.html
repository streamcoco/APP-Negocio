<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AVE FENIX MULTIVENTAS</title>
    <!-- Pico.css para un diseño moderno y responsivo -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <!-- Iconos de Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            background-color: #f0f2f5;
        }

        .container {
            max-width: 90%;
            margin: auto;
            padding: 1rem;
        }

        .title {
            text-align: center;
            font-size: 2.5rem;
            color: #333;
            font-weight: bold;
            margin-top: 2rem;
            margin-bottom: 2rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .menu-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 2rem;
            border-radius: 1rem;
            background-color: #fff;
            color: #007bff;
            border: 2px solid #007bff;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.2);
            font-weight: bold;
            text-transform: uppercase;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .menu-button:hover {
            background-color: #007bff;
            color: #fff;
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 123, 255, 0.4);
        }

        .menu-button .fa-solid {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }

        .section-container {
            display: none;
        }

        .section-container.active {
            display: block;
        }

        .card {
            background-color: #fff;
            border-radius: 1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 2rem;
            margin-top: 1rem;
        }

        h2 {
            text-align: center;
            color: #444;
            margin-bottom: 1.5rem;
        }

        table {
            width: 100%;
            margin-top: 1rem;
            border-collapse: collapse;
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        @media (max-width: 768px) {
            .menu-grid {
                grid-template-columns: 1fr;
            }

            .title {
                font-size: 1.8rem;
            }
        }

        /* Estilos del carrito y el lector de códigos de barras */
        .cart-item-list {
            list-style: none;
            padding: 0;
        }

        .cart-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
        }

        .cart-item-info {
            flex-grow: 1;
        }

        .cart-item-quantity {
            display: flex;
            align-items: center;
        }

        .cart-item-quantity button {
            padding: 0.25rem 0.5rem;
            font-size: 1rem;
            margin: 0 0.25rem;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            width: 90%;
            max-width: 500px;
            text-align: center;
        }

        .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        #barcode-scanner-area {
            width: 100%;
            height: 300px;
            background: #000;
            margin-bottom: 1rem;
        }

        .receipt {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.2;
            width: 250px;
            margin: auto;
            border: 1px dashed #ccc;
            padding: 10px;
        }
        
        .receipt-header, .receipt-footer {
            text-align: center;
            margin-bottom: 10px;
        }

        .receipt-header p {
            margin: 0;
            line-height: 1;
        }

        .receipt-details {
            border-top: 1px dashed #000;
            border-bottom: 1px dashed #000;
            padding: 5px 0;
        }

        .receipt-item {
            display: flex;
            justify-content: space-between;
        }

        .receipt-total {
            text-align: right;
            font-weight: bold;
            font-size: 14px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">AVE FENIX MULTIVENTAS</h1>
        <main>
            <div class="menu-grid">
                <a href="#carrito" role="button" class="menu-button">
                    <i class="fa-solid fa-cart-shopping"></i>
                    <span>Carrito</span>
                </a>
                <a href="#productos" role="button" class="menu-button">
                    <i class="fa-solid fa-box-open"></i>
                    <span>Productos</span>
                </a>
                <a href="#clientes" role="button" class="menu-button">
                    <i class="fa-solid fa-users"></i>
                    <span>Clientes</span>
                </a>
                <a href="#historial" role="button" class="menu-button">
                    <i class="fa-solid fa-clock-rotate-left"></i>
                    <span>Historial</span>
                </a>
                <a href="#estadistica" role="button" class="menu-button">
                    <i class="fa-solid fa-chart-line"></i>
                    <span>Estadística</span>
                </a>
            </div>

            <div id="carrito" class="section-container active">
                <article class="card">
                    <h2>Carrito de Venta</h2>
                    <div class="grid">
                        <label for="product-search">Buscar Producto por nombre o código
                            <input type="text" id="product-search" name="product-search">
                            <div id="search-suggestions" role="listbox"></div>
                        </label>
                        <button onclick="openBarcodeScannerModal()" class="secondary"><i class="fa-solid fa-barcode"></i> Escanear Código</button>
                    </div>

                    <h3>Productos en Carrito</h3>
                    <ul id="cart-item-list" class="cart-item-list">
                        <!-- Los productos en el carrito se cargarán aquí -->
                    </ul>
                    <hr>
                    <div style="text-align: right; font-weight: bold; font-size: 1.2rem;">
                        Total: $<span id="cart-total">0</span>
                    </div>
                    <br>
                    <button onclick="generateReceipt()" class="contrast" style="width: 100%;">Generar Boleta</button>
                </article>
            </div>

            <div id="productos" class="section-container">
                <article class="card">
                    <h2>Gestión de Productos</h2>
                    <form id="product-form">
                        <div class="grid">
                            <label for="product-code">Código
                                <input type="text" id="product-code" name="product-code">
                            </label>
                            <label for="product-name">Producto
                                <input type="text" id="product-name" name="product-name" required>
                            </label>
                            <label for="product-price">Precio
                                <input type="number" id="product-price" name="product-price" required>
                            </label>
                            <label for="product-stock">Stock
                                <input type="number" id="product-stock" name="product-stock">
                            </label>
                        </div>
                        <button type="submit" class="contrast">Añadir/Guardar Producto</button>
                    </form>
                    <hr>
                    <input type="file" id="import-products" accept=".csv, .xlsx">
                    <button onclick="importProducts()" class="secondary">Importar Excel</button>
                    <p id="import-products-message"></p>
                    <br>
                    <table>
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Producto</th>
                                <th>Precio</th>
                                <th>Stock</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="product-list">
                            <!-- Los productos se cargarán aquí -->
                        </tbody>
                    </table>
                </article>
            </div>

            <div id="clientes" class="section-container">
                <article class="card">
                    <h2>Gestión de Clientes</h2>
                    <form id="client-form">
                        <div class="grid">
                            <label for="client-name">Nombre
                                <input type="text" id="client-name" name="client-name" required>
                            </label>
                            <label for="client-phone">Teléfono
                                <input type="text" id="client-phone" name="client-phone">
                            </label>
                            <label for="client-address">Dirección
                                <input type="text" id="client-address" name="client-address">
                            </label>
                        </div>
                        <button type="submit" class="contrast">Añadir/Guardar Cliente</button>
                    </form>
                    <hr>
                    <input type="file" id="import-clients" accept=".csv, .xlsx">
                    <button onclick="importClients()" class="secondary">Importar Excel</button>
                    <p id="import-clients-message"></p>
                    <br>
                    <table>
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Teléfono</th>
                                <th>Dirección</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="client-list">
                            <!-- Los clientes se cargarán aquí -->
                        </tbody>
                    </table>
                </article>
            </div>

            <div id="historial" class="section-container">
                <article class="card">
                    <h2>Historial de Ventas</h2>
                    <table style="width: 100%;">
                        <thead>
                            <tr>
                                <th>N° Boleta</th>
                                <th>Fecha</th>
                                <th>Cliente</th>
                                <th>Total</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="sales-history-list">
                            <!-- El historial de ventas se cargará aquí -->
                        </tbody>
                    </table>
                </article>
            </div>

            <div id="estadistica" class="section-container">
                <article class="card">
                    <h2>Estadísticas</h2>
                    <div class="grid">
                        <label for="filter-client">Filtrar por Cliente
                            <select id="filter-client">
                                <option value="">Todos los clientes</option>
                                <!-- Los clientes se cargarán aquí -->
                            </select>
                        </label>
                        <label for="start-date">Fecha de inicio
                            <input type="date" id="start-date">
                        </label>
                        <label for="end-date">Fecha de fin
                            <input type="date" id="end-date">
                        </label>
                    </div>
                    <button onclick="renderStatistics()" class="secondary">Aplicar Filtros</button>
                    <hr>
                    <div class="grid">
                        <div class="card">
                            <h3>Total de Ventas</h3>
                            <p style="font-size: 2rem; font-weight: bold;">$<span id="total-sales">0</span></p>
                        </div>
                        <div class="card">
                            <h3>Productos Más Vendidos</h3>
                            <ul id="top-products-list" style="list-style: none; padding: 0; text-align: left;">
                                <!-- Los productos más vendidos se cargarán aquí -->
                            </ul>
                        </div>
                    </div>
                </article>
            </div>
        </main>
    </div>

    <!-- Modal para el lector de códigos de barras -->
    <div id="barcode-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeBarcodeScannerModal()">&times;</span>
            <h3>Escanear Código de Barras</h3>
            <div id="barcode-scanner-area"></div>
            <p id="barcode-result-message"></p>
        </div>
    </div>
    
    <!-- Modal para la boleta -->
    <div id="receipt-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeReceiptModal()">&times;</span>
            <div id="receipt-content" class="receipt">
                <!-- El contenido de la boleta se cargará aquí -->
            </div>
            <button onclick="printReceipt()" class="contrast" style="margin-top: 1rem;">Imprimir Boleta</button>
        </div>
    </div>
    
    <!-- Modal para detalles de venta -->
    <div id="sale-details-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeSaleDetailsModal()">&times;</span>
            <h3>Detalle de la Venta</h3>
            <div id="sale-details-content" class="receipt">
                <!-- Los detalles de la venta se cargan aquí -->
            </div>
        </div>
    </div>

    <!-- Librería js-xlsx para importar archivos de Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <!-- Librería QuaggaJS para el escáner de códigos de barras -->
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <script>
        // Funciones para gestionar el localStorage y la interfaz de usuario

        // Identifica los elementos HTML
        const productForm = document.getElementById('product-form');
        const clientForm = document.getElementById('client-form');
        const productList = document.getElementById('product-list');
        const clientList = document.getElementById('client-list');
        const productSearch = document.getElementById('product-search');
        const cartItemList = document.getElementById('cart-item-list');
        const cartTotalEl = document.getElementById('cart-total');
        const barcodeModal = document.getElementById('barcode-modal');
        const receiptModal = document.getElementById('receipt-modal');
        const receiptContent = document.getElementById('receipt-content');
        const salesHistoryList = document.getElementById('sales-history-list');
        const totalSalesEl = document.getElementById('total-sales');
        const topProductsList = document.getElementById('top-products-list');
        const saleDetailsModal = document.getElementById('sale-details-modal');
        const saleDetailsContent = document.getElementById('sale-details-content');
        const filterClientSelect = document.getElementById('filter-client');
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');

        let editProductIndex = -1; // Para saber si estamos editando un producto
        let editClientIndex = -1; // Para saber si estamos editando un cliente

        // --- Funciones de gestión de datos ---

        function getProducts() {
            return JSON.parse(localStorage.getItem('products')) || [];
        }

        function saveProducts(products) {
            localStorage.setItem('products', JSON.stringify(products));
        }

        function getClients() {
            return JSON.parse(localStorage.getItem('clients')) || [];
        }

        function saveClients(clients) {
            localStorage.setItem('clients', JSON.stringify(clients));
        }

        function getCart() {
            return JSON.parse(localStorage.getItem('cart')) || [];
        }

        function saveCart(cart) {
            localStorage.setItem('cart', JSON.stringify(cart));
        }

        function getSalesHistory() {
            return JSON.parse(localStorage.getItem('salesHistory')) || [];
        }
        
        function saveSalesHistory(history) {
            localStorage.setItem('salesHistory', JSON.stringify(history));
        }

        function getReceiptNumber() {
            const currentNumber = parseInt(localStorage.getItem('receiptNumber') || '0');
            return currentNumber + 1;
        }

        function incrementReceiptNumber() {
            let currentNumber = parseInt(localStorage.getItem('receiptNumber') || '0');
            localStorage.setItem('receiptNumber', currentNumber + 1);
        }
        
        // --- Funciones de renderizado (UI) ---

        function renderProducts() {
            const products = getProducts();
            productList.innerHTML = '';
            products.forEach((product, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.code || 'N/A'}</td>
                    <td>${product.name}</td>
                    <td>${product.price}</td>
                    <td>${product.stock || 'N/A'}</td>
                    <td>
                        <button onclick="editProduct(${index})" class="secondary">Editar</button>
                        <button onclick="deleteProduct(${index})" class="contrast">Eliminar</button>
                    </td>
                `;
                productList.appendChild(row);
            });
        }

        function renderClients() {
            const clients = getClients();
            clientList.innerHTML = '';
            filterClientSelect.innerHTML = '<option value="">Todos los clientes</option>'; // Limpiar opciones
            clients.forEach((client, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${client.name}</td>
                    <td>${client.phone || 'N/A'}</td>
                    <td>${client.address || 'N/A'}</td>
                    <td>
                        <button onclick="editClient(${index})" class="secondary">Editar</button>
                        <button onclick="deleteClient(${index})" class="contrast">Eliminar</button>
                    </td>
                `;
                clientList.appendChild(row);

                // Añadir opción al filtro de estadísticas
                const option = document.createElement('option');
                option.value = client.name;
                option.textContent = client.name;
                filterClientSelect.appendChild(option);
            });
        }

        function renderCart() {
            const cart = getCart();
            cartItemList.innerHTML = '';
            let total = 0;
            if (cart.length === 0) {
                cartItemList.innerHTML = '<p style="text-align: center;">El carrito está vacío.</p>';
            } else {
                cart.forEach((item, index) => {
                    const listItem = document.createElement('li');
                    listItem.classList.add('cart-item');
                    const subtotal = item.product.price * item.quantity;
                    total += subtotal;
                    listItem.innerHTML = `
                        <div class="cart-item-info">
                            <strong>${item.product.name}</strong><br>
                            <small>Precio: $${item.product.price} x ${item.quantity}</small>
                        </div>
                        <div class="cart-item-quantity">
                            <button onclick="updateCartItemQuantity(${index}, -1)">-</button>
                            <span style="min-width: 20px; text-align: center;">${item.quantity}</span>
                            <button onclick="updateCartItemQuantity(${index}, 1)">+</button>
                            <button onclick="removeFromCart(${index})" class="contrast">Eliminar</button>
                        </div>
                    `;
                    cartItemList.appendChild(listItem);
                });
            }
            cartTotalEl.textContent = total;
            saveCart(cart);
        }

        function renderSalesHistory() {
            const history = getSalesHistory();
            salesHistoryList.innerHTML = '';
            history.sort((a, b) => new Date(b.date) - new Date(a.date)); // Ordena por fecha (el más reciente primero)
            
            if (history.length === 0) {
                salesHistoryList.innerHTML = '<tr><td colspan="5" style="text-align: center;">No hay ventas registradas.</td></tr>';
                return;
            }

            history.forEach(sale => {
                const row = document.createElement('tr');
                row.style.cursor = 'pointer';
                row.onclick = () => showSaleDetails(sale.id);
                row.innerHTML = `
                    <td>${String(sale.id).padStart(4, '0')}</td>
                    <td>${new Date(sale.date).toLocaleString()}</td>
                    <td>${sale.clientName || 'N/A'}</td>
                    <td>$${sale.total.toFixed(0)}</td>
                    <td><button onclick="event.stopPropagation(); showSaleDetails(${sale.id})" class="secondary">Ver</button></td>
                `;
                salesHistoryList.appendChild(row);
            });
        }

        function renderStatistics() {
            const history = getSalesHistory();
            const selectedClient = filterClientSelect.value;
            const startDate = startDateInput.value ? new Date(startDateInput.value) : null;
            const endDate = endDateInput.value ? new Date(endDateInput.value) : null;
            
            const filteredHistory = history.filter(sale => {
                const saleDate = new Date(sale.date);
                const clientMatch = !selectedClient || sale.clientName === selectedClient;
                const dateMatch = (!startDate || saleDate >= startDate) && (!endDate || saleDate <= endDate);
                return clientMatch && dateMatch;
            });
            
            let totalSales = 0;
            const productSales = {};

            filteredHistory.forEach(sale => {
                totalSales += sale.total;
                sale.items.forEach(item => {
                    if (productSales[item.product.name]) {
                        productSales[item.product.name] += item.quantity;
                    } else {
                        productSales[item.product.name] = item.quantity;
                    }
                });
            });

            // Ordenar productos por cantidad vendida
            const sortedProducts = Object.entries(productSales).sort(([, a], [, b]) => b - a);

            totalSalesEl.textContent = totalSales.toFixed(0);
            topProductsList.innerHTML = '';
            if (sortedProducts.length === 0) {
                topProductsList.innerHTML = '<li>No hay productos vendidos en este período.</li>';
            } else {
                sortedProducts.slice(0, 5).forEach(([name, quantity]) => {
                    const listItem = document.createElement('li');
                    listItem.textContent = `${name}: ${quantity} unidades`;
                    topProductsList.appendChild(listItem);
                });
            }
        }

        // --- Funciones de formulario y acciones ---

        productForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const products = getProducts();
            const code = document.getElementById('product-code').value;
            const name = document.getElementById('product-name').value;
            const price = document.getElementById('product-price').value;
            const stock = document.getElementById('product-stock').value;

            // Si estamos editando, actualizamos el producto existente
            if (editProductIndex !== -1) {
                products[editProductIndex] = {
                    code: code || null,
                    name: name,
                    price: parseFloat(price),
                    stock: stock ? parseInt(stock) : null
                };
                editProductIndex = -1;
            } else {
                // Si no, añadimos un nuevo producto
                products.push({
                    code: code || null,
                    name: name,
                    price: parseFloat(price),
                    stock: stock ? parseInt(stock) : null
                });
            }
            saveProducts(products);
            productForm.reset();
            renderProducts();
        });

        function editProduct(index) {
            const products = getProducts();
            const product = products[index];
            document.getElementById('product-code').value = product.code;
            document.getElementById('product-name').value = product.name;
            document.getElementById('product-price').value = product.price;
            document.getElementById('product-stock').value = product.stock;
            editProductIndex = index; // Guardamos el índice para la edición
        }

        function deleteProduct(index) {
            const products = getProducts();
            products.splice(index, 1);
            saveProducts(products);
            renderProducts();
        }

        clientForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const clients = getClients();
            const name = document.getElementById('client-name').value;
            const phone = document.getElementById('client-phone').value;
            const address = document.getElementById('client-address').value;

            if (editClientIndex !== -1) {
                clients[editClientIndex] = { name, phone: phone || null, address: address || null };
                editClientIndex = -1;
            } else {
                clients.push({ name, phone: phone || null, address: address || null });
            }
            
            saveClients(clients);
            clientForm.reset();
            renderClients();
        });

        function editClient(index) {
            const clients = getClients();
            const client = clients[index];
            document.getElementById('client-name').value = client.name;
            document.getElementById('client-phone').value = client.phone;
            document.getElementById('client-address').value = client.address;
            editClientIndex = index;
        }

        function deleteClient(index) {
            const clients = getClients();
            clients.splice(index, 1);
            saveClients(clients);
            renderClients();
        }

        function importProducts() {
            const fileInput = document.getElementById('import-products');
            const file = fileInput.files[0];
            const messageEl = document.getElementById('import-products-message');
            if (!file) {
                messageEl.textContent = 'Por favor, selecciona un archivo de Excel.';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1, raw: false});

                    if (jsonData.length < 2) {
                        messageEl.textContent = 'El archivo de Excel está vacío o no tiene el formato correcto.';
                        return;
                    }

                    const products = getProducts();
                    const headers = jsonData[0].map(h => h.trim().toLowerCase());
                    const articleIndex = headers.indexOf('articulo');
                    const priceIndex = headers.indexOf('precio');
                    const codeIndex = headers.indexOf('codigo');
                    const stockIndex = headers.indexOf('stock');

                    if (articleIndex === -1 || priceIndex === -1) {
                        messageEl.textContent = 'El archivo debe tener las columnas "Articulo" y "precio".';
                        return;
                    }

                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (row.length === 0) continue;

                        const product = {
                            code: codeIndex !== -1 ? (row[codeIndex] || null) : null,
                            name: row[articleIndex] || '',
                            price: priceIndex !== -1 ? parseFloat(row[priceIndex]) : 0,
                            stock: stockIndex !== -1 ? (row[stockIndex] ? parseInt(row[stockIndex]) : null) : null,
                        };
                        
                        if (product.name && !isNaN(product.price)) {
                            products.push(product);
                        }
                    }

                    saveProducts(products);
                    renderProducts();
                    messageEl.textContent = 'Productos importados con éxito.';
                    fileInput.value = '';
                } catch (error) {
                    console.error('Error al importar productos:', error);
                    messageEl.textContent = 'Error al procesar el archivo. Asegúrate de que es un archivo de Excel válido.';
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function importClients() {
            const fileInput = document.getElementById('import-clients');
            const file = fileInput.files[0];
            const messageEl = document.getElementById('import-clients-message');
            if (!file) {
                messageEl.textContent = 'Por favor, selecciona un archivo de Excel.';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1, raw: false});

                    if (jsonData.length < 2) {
                        messageEl.textContent = 'El archivo de Excel está vacío o no tiene el formato correcto.';
                        return;
                    }

                    const clients = getClients();
                    const headers = jsonData[0].map(h => h.trim().toLowerCase());
                    const nameIndex = headers.indexOf('nombre');
                    const phoneIndex = headers.indexOf('telefono');
                    const addressIndex = headers.indexOf('direccion');

                    if (nameIndex === -1) {
                        messageEl.textContent = 'El archivo debe tener la columna "Nombre".';
                        return;
                    }

                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (row.length === 0) continue;
                        const client = {
                            name: row[nameIndex] || '',
                            phone: phoneIndex !== -1 ? (row[phoneIndex] || null) : null,
                            address: addressIndex !== -1 ? (row[addressIndex] || null) : null,
                        };

                        if (client.name) {
                            clients.push(client);
                        }
                    }
                    saveClients(clients);
                    renderClients();
                    messageEl.textContent = 'Clientes importados con éxito.';
                    fileInput.value = '';
                } catch (error) {
                    console.error('Error al importar clientes:', error);
                    messageEl.textContent = 'Error al procesar el archivo. Asegúrate de que es un archivo de Excel válido.';
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // --- Funciones del Carrito ---

        productSearch.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const suggestionsEl = document.getElementById('search-suggestions');
            suggestionsEl.innerHTML = '';
            
            if (searchTerm.length > 0) {
                const products = getProducts();
                const filteredProducts = products.filter(p => 
                    p.name.toLowerCase().includes(searchTerm) || 
                    (p.code && p.code.toLowerCase().includes(searchTerm))
                );

                if (filteredProducts.length > 0) {
                    suggestionsEl.style.border = '1px solid #ccc';
                    filteredProducts.forEach(product => {
                        const suggestionItem = document.createElement('div');
                        suggestionItem.classList.add('search-suggestion-item');
                        suggestionItem.style.padding = '0.5rem';
                        suggestionItem.style.cursor = 'pointer';
                        suggestionItem.style.borderBottom = '1px solid #eee';
                        suggestionItem.textContent = `${product.name} - $${product.price}`;
                        suggestionItem.addEventListener('click', () => {
                            addToCart(product);
                            productSearch.value = '';
                            suggestionsEl.innerHTML = '';
                            suggestionsEl.style.border = 'none';
                        });
                        suggestionsEl.appendChild(suggestionItem);
                    });
                } else {
                    suggestionsEl.style.border = 'none';
                }
            } else {
                suggestionsEl.innerHTML = '';
                suggestionsEl.style.border = 'none';
            }
        });

        function addToCart(product) {
            const cart = getCart();
            const existingItem = cart.find(item => item.product.code === product.code);
            
            if (existingItem) {
                existingItem.quantity++;
            } else {
                cart.push({ product: product, quantity: 1 });
            }

            saveCart(cart);
            renderCart();
        }

        function updateCartItemQuantity(index, change) {
            const cart = getCart();
            const item = cart[index];
            item.quantity += change;

            if (item.quantity <= 0) {
                cart.splice(index, 1);
            }
            saveCart(cart);
            renderCart();
        }

        function removeFromCart(index) {
            const cart = getCart();
            cart.splice(index, 1);
            saveCart(cart);
            renderCart();
        }

        function clearCart() {
            localStorage.removeItem('cart');
            renderCart();
        }

        // --- Lector de códigos de barras (QuaggaJS) ---

        let quaggaIsRunning = false;
        
        function openBarcodeScannerModal() {
            barcodeModal.style.display = 'flex';
            if (!quaggaIsRunning) {
                startBarcodeScanner();
            }
        }
        
        function closeBarcodeScannerModal() {
            barcodeModal.style.display = 'none';
            stopBarcodeScanner();
        }

        function startBarcodeScanner() {
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#barcode-scanner-area'),
                    constraints: {
                        width: 640,
                        height: 480,
                        facingMode: "environment" // Usa la cámara trasera
                    },
                },
                decoder: {
                    readers: ["ean_reader", "code_128_reader", "upc_reader", "ean_8_reader", "code_39_reader"]
                }
            }, function (err) {
                if (err) {
                    console.log(err);
                    document.getElementById('barcode-result-message').textContent = 'Error al iniciar la cámara.';
                    return;
                }
                quaggaIsRunning = true;
                Quagga.start();
                document.getElementById('barcode-result-message').textContent = 'Escaneando...';
            });
            
            Quagga.onDetected(function (data) {
                console.log("Barcode detected and processed: ", data);
                const code = data.codeResult.code;
                const products = getProducts();
                const foundProduct = products.find(p => p.code === code);
                
                if (foundProduct) {
                    addToCart(foundProduct);
                    document.getElementById('barcode-result-message').textContent = `Producto encontrado y añadido: ${foundProduct.name}`;
                    // Optional: stop scanner after finding one product
                    // closeBarcodeScannerModal(); 
                } else {
                    document.getElementById('barcode-result-message').textContent = `Producto con código ${code} no encontrado.`;
                }
            });
        }
        
        function stopBarcodeScanner() {
            if (quaggaIsRunning) {
                Quagga.stop();
                quaggaIsRunning = false;
            }
        }

        // --- Generación e impresión de Boleta ---

        function generateReceipt() {
            const cart = getCart();
            if (cart.length === 0) {
                alert('El carrito está vacío. Añade productos para generar una boleta.');
                return;
            }
            
            const receiptNumber = getReceiptNumber();
            const date = new Date();
            
            let itemsHtml = '';
            let total = 0;
            
            cart.forEach(item => {
                const subtotal = item.product.price * item.quantity;
                total += subtotal;
                itemsHtml += `
                    <div class="receipt-item">
                        <span>${item.product.name}</span>
                        <span>$${item.product.price} x ${item.quantity} = $${subtotal.toFixed(0)}</span>
                    </div>
                `;
            });
            
            // Simular selección de cliente
            const selectedClient = prompt('Introduce el nombre del cliente (opcional):');

            const receiptHtml = `
                <div class="receipt-header">
                    <h3>AVEFENIX MULTIVENTAS</h3>
                    <p>Boleta N° ${String(receiptNumber).padStart(4, '0')}</p>
                    <p>${date.toLocaleDateString()} ${date.toLocaleTimeString()}</p>
                    <p>Cliente: ${selectedClient || 'N/A'}</p>
                </div>
                <div class="receipt-details">
                    ${itemsHtml}
                </div>
                <div class="receipt-total">
                    TOTAL: $${total.toFixed(0)}
                </div>
                <div class="receipt-footer">
                    <p>¡Gracias por tu compra!</p>
                </div>
            `;
            
            receiptContent.innerHTML = receiptHtml;
            receiptModal.style.display = 'flex';

            // Guardar la venta en el historial antes de imprimir
            const sale = {
                id: receiptNumber,
                date: date.toISOString(),
                clientName: selectedClient || null,
                total: total,
                items: cart
            };
            saveSale(sale);
        }

        function saveSale(sale) {
            const history = getSalesHistory();
            history.push(sale);
            saveSalesHistory(history);
            renderSalesHistory();
            renderStatistics();
        }

        function showSaleDetails(saleId) {
            const history = getSalesHistory();
            const sale = history.find(s => s.id === saleId);
            if (!sale) return;

            let itemsHtml = '';
            sale.items.forEach(item => {
                const subtotal = item.product.price * item.quantity;
                itemsHtml += `
                    <div class="receipt-item">
                        <span>${item.product.name}</span>
                        <span>$${item.product.price} x ${item.quantity} = $${subtotal.toFixed(0)}</span>
                    </div>
                `;
            });

            const saleDetailsHtml = `
                <div class="receipt-header">
                    <h3>AVEFENIX MULTIVENTAS</h3>
                    <p>Boleta N° ${String(sale.id).padStart(4, '0')}</p>
                    <p>${new Date(sale.date).toLocaleDateString()} ${new Date(sale.date).toLocaleTimeString()}</p>
                    <p>Cliente: ${sale.clientName || 'N/A'}</p>
                </div>
                <div class="receipt-details">
                    ${itemsHtml}
                </div>
                <div class="receipt-total">
                    TOTAL: $${sale.total.toFixed(0)}
                </div>
                <div class="receipt-footer">
                    <p>¡Gracias por tu compra!</p>
                </div>
            `;
            saleDetailsContent.innerHTML = saleDetailsHtml;
            saleDetailsModal.style.display = 'flex';
        }

        function closeReceiptModal() {
            receiptModal.style.display = 'none';
        }

        function closeSaleDetailsModal() {
            saleDetailsModal.style.display = 'none';
        }

        function printReceipt() {
            const receiptSection = document.getElementById('receipt-content');
            const originalContents = document.body.innerHTML;
            const printContents = receiptSection.innerHTML;
            
            document.body.innerHTML = printContents;
            window.print();
            
            document.body.innerHTML = originalContents;
            window.location.reload(); // Recarga para restaurar la interfaz
            incrementReceiptNumber();
            clearCart();
        }

        // --- Manejador para el cambio de secciones ---
        document.addEventListener('DOMContentLoaded', () => {
            const sections = document.querySelectorAll('.section-container');
            const menuButtons = document.querySelectorAll('.menu-button');

            function showSection(sectionId) {
                sections.forEach(section => {
                    section.classList.remove('active');
                });
                menuButtons.forEach(button => {
                    button.removeAttribute('aria-current');
                });

                const targetSection = document.getElementById(sectionId);
                const targetButton = document.querySelector(`.menu-button[href="#${sectionId}"]`);
                
                if (targetSection) {
                    targetSection.classList.add('active');
                    if (targetButton) {
                        targetButton.setAttribute('aria-current', 'page');
                    }
                }
            }

            menuButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    const sectionId = button.getAttribute('href').substring(1);
                    showSection(sectionId);
                });
            });

            // Muestra la sección inicial
            const initialSectionId = window.location.hash.substring(1) || 'carrito';
            showSection(initialSectionId);

            // Carga los datos iniciales
            renderProducts();
            renderClients();
            renderCart();
            renderSalesHistory();
            renderStatistics();
        });

        // Simula alert() con un modal para evitar errores en el entorno de vista previa
        window.alert = function(message) {
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '50%';
            modal.style.left = '50%';
            modal.style.transform = 'translate(-50%, -50%)';
            modal.style.backgroundColor = 'white';
            modal.style.padding = '20px';
            modal.style.border = '1px solid black';
            modal.style.zIndex = '9999';
            modal.style.borderRadius = '8px';
            modal.style.boxShadow = '0 4px 15px rgba(0,0,0,0.2)';
            modal.innerHTML = `<p>${message}</p><button onclick="this.parentNode.remove()">OK</button>`;
            document.body.appendChild(modal);
        };
    </script>
</body>
</html>

